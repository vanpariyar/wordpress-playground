import{existsSync as v,writeFileSync as f,mkdtempSync as P,rmSync as w,rmdirSync as y}from"fs";import{rootCertificates as E}from"tls";import{LatestSupportedPHPVersion as S,SupportedPHPVersionsList as $,PHP as g}from"@php-wasm/universal";import{spawn as R}from"child_process";import{loadNodeRuntime as C,useHostFilesystem as k}from"@php-wasm/node";const H="modulepreload",L=function(a){return"/"+a},d={},_=function(r,c,p){if(!c||c.length===0)return r();const i=document.getElementsByTagName("link");return Promise.all(c.map(t=>{if(t=L(t),t in d)return;d[t]=!0;const e=t.endsWith(".css"),m=e?'[rel="stylesheet"]':"";if(!!p)for(let n=i.length-1;n>=0;n--){const l=i[n];if(l.href===t&&(!e||l.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${t}"]${m}`))return;const s=document.createElement("link");if(s.rel=e?"stylesheet":H,e||(s.as="script",s.crossOrigin=""),s.href=t,document.head.appendChild(s),e)return new Promise((n,l)=>{s.addEventListener("load",n),s.addEventListener("error",()=>l(new Error(`Unable to preload CSS for ${t}`)))})})).then(()=>r()).catch(t=>{const e=new Event("vite:preloadError",{cancelable:!0});if(e.payload=t,window.dispatchEvent(e),!e.defaultPrevented)throw t})};let o=process.argv.slice(2);o.length||(o=["--help"]);const h=new URL("ca-bundle.crt",(import.meta||{}).url).pathname;v(h)||f(h,E.join(`
`));o.unshift("-d",`openssl.cafile=${h}`);async function x(){const a=await _(()=>import("./assets/php-e1f9edd4.js"),[]),r=process.env.PHP||S;if(!$.includes(r))throw new Error(`Unsupported PHP version ${r}`);const{TMPDIR:c,...p}=process.env,i=new g(await C(r,{emscriptenOptions:{ENV:{...p,TERM:"xterm"}}}));k(i),i.setSpawnHandler(e=>{const m=`${process.argv[0]} ${process.execArgv.join(" ")} ${process.argv[1]}`,u=e.replace(/^(?:\\ |[^ ])*php\d?(\s|$)/,m+"$1"),s=P("php-wasm-"),n=`${s}/script.sh`;f(n,`#!/bin/sh
	${u} < /dev/stdin
	`);try{return R(u,[],{shell:!0,stdio:["pipe","pipe","pipe"],timeout:5e3})}finally{w(n),y(s)}}),o.some(e=>e.startsWith("-c"))||o.unshift("-c",a),await i.cli(["php",...o]).catch(e=>{throw e.name==="ExitStatus"&&process.exit(e.status===void 0?1:e.status),e}).finally(()=>{setTimeout(()=>{process.exit(0)},100)})}x();
