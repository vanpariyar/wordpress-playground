"use strict";var b=(i,e,s)=>{if(!e.has(i))throw TypeError("Cannot "+s)};var n=(i,e,s)=>(b(i,e,"read from private field"),s?s.call(i):e.get(i)),d=(i,e,s)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,s)},_=(i,e,s,t)=>(b(i,e,"write to private field"),t?t.call(i,s):e.set(i,s),s);var P=(i,e,s,t)=>({set _(o){_(i,e,o,s)},get _(){return n(i,e,t)}}),v=(i,e,s)=>(b(i,e,"access private method"),s);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});require("@php-wasm/node-polyfills");const I=require("@php-wasm/logger"),R=5*1024*1024;var h,l,m,O;class M extends EventTarget{constructor(){super(...arguments);d(this,m);d(this,h,{});d(this,l,{})}expectAssets(s){for(const[t,o]of Object.entries(s)){const r="http://example.com/",a=new URL(t,r).pathname.split("/").pop();a in n(this,h)||(n(this,h)[a]=o),a in n(this,l)||(n(this,l)[a]=0)}}async monitorFetch(s){const t=await s;return C(t,r=>{v(this,m,O).call(this,t.url,r.detail.loaded,r.detail.total)})}}h=new WeakMap,l=new WeakMap,m=new WeakSet,O=function(s,t,o){const r=new URL(s,"http://example.com").pathname.split("/").pop();o?r in n(this,h)||(n(this,h)[r]=o,n(this,l)[r]=t):o=n(this,h)[r],r in n(this,l)||I.logger.warn(`Registered a download #progress of an unregistered file "${r}". This may cause a sudden **decrease** in the #progress percentage as the total number of bytes increases during the download.`),n(this,l)[r]=t,this.dispatchEvent(new CustomEvent("progress",{detail:{loaded:T(n(this,l)),total:T(n(this,h))}}))};function T(i){return Object.values(i).reduce((e,s)=>e+s,0)}function C(i,e){const s=i.headers.get("content-length")||"",t=parseInt(s,10)||R;function o(r,c){e(new CustomEvent("progress",{detail:{loaded:r,total:c}}))}return new Response(new ReadableStream({async start(r){if(!i.body){r.close();return}const c=i.body.getReader();let a=0;for(;;)try{const{done:p,value:E}=await c.read();if(E&&(a+=E.byteLength),p){o(a,a),r.close();break}else o(a,t),r.enqueue(E)}catch(p){I.logger.error({e:p}),r.error(p);break}}}),{status:i.status,statusText:i.statusText,headers:i.headers})}var g,f,u,y;class k extends EventTarget{constructor(){super(...arguments);d(this,u);d(this,g,void 0);d(this,f,void 0);_(this,g,{}),_(this,f,0),this.progress=0,this.mode="REAL_TIME",this.caption=""}partialObserver(s,t=""){const o=++P(this,f)._;return n(this,g)[o]=0,r=>{const{loaded:c,total:a}=(r==null?void 0:r.detail)||{};n(this,g)[o]=c/a*s,v(this,u,y).call(this,this.totalProgress,"REAL_TIME",t)}}slowlyIncrementBy(s){const t=++P(this,f)._;n(this,g)[t]=s,v(this,u,y).call(this,this.totalProgress,"SLOWLY_INCREMENT")}get totalProgress(){return Object.values(n(this,g)).reduce((s,t)=>s+t,0)}}g=new WeakMap,f=new WeakMap,u=new WeakSet,y=function(s,t,o){this.dispatchEvent(new CustomEvent("progress",{detail:{progress:s,mode:t,caption:o}}))};const L=1e-5;class w extends EventTarget{constructor({weight:e=1,caption:s="",fillTime:t=4}={}){super(),this._selfWeight=1,this._selfDone=!1,this._selfProgress=0,this._selfCaption="",this._isFilling=!1,this._subTrackers=[],this._weight=e,this._selfCaption=s,this._fillTime=t}stage(e,s=""){if(e||(e=this._selfWeight),this._selfWeight-e<-L)throw new Error(`Cannot add a stage with weight ${e} as the total weight of registered stages would exceed 1.`);this._selfWeight-=e;const t=new w({caption:s,weight:e,fillTime:this._fillTime});return this._subTrackers.push(t),t.addEventListener("progress",()=>this.notifyProgress()),t.addEventListener("done",()=>{this.done&&this.notifyDone()}),t}fillSlowly({stopBeforeFinishing:e=!0}={}){if(this._isFilling)return;this._isFilling=!0;const s=100,t=this._fillTime/s;this._fillInterval=setInterval(()=>{this.set(this._selfProgress+1),e&&this._selfProgress>=99&&clearInterval(this._fillInterval)},t)}set(e){this._selfProgress=Math.min(e,100),this.notifyProgress(),this._selfProgress+L>=100&&this.finish()}finish(){this._fillInterval&&clearInterval(this._fillInterval),this._selfDone=!0,this._selfProgress=100,this._isFilling=!1,this._fillInterval=void 0,this.notifyProgress(),this.notifyDone()}get caption(){for(let e=this._subTrackers.length-1;e>=0;e--)if(!this._subTrackers[e].done){const s=this._subTrackers[e].caption;if(s)return s}return this._selfCaption}setCaption(e){this._selfCaption=e,this.notifyProgress()}get done(){return this.progress+L>=100}get progress(){if(this._selfDone)return 100;const e=this._subTrackers.reduce((s,t)=>s+t.progress*t.weight,this._selfProgress*this._selfWeight);return Math.round(e*1e4)/1e4}get weight(){return this._weight}get observer(){return this._progressObserver||(this._progressObserver=e=>{this.set(e)}),this._progressObserver}get loadingListener(){return this._loadingListener||(this._loadingListener=e=>{this.set(e.detail.loaded/e.detail.total*100)}),this._loadingListener}pipe(e){e.setProgress({progress:this.progress,caption:this.caption}),this.addEventListener("progress",s=>{e.setProgress({progress:s.detail.progress,caption:s.detail.caption})}),this.addEventListener("done",()=>{e.setLoaded()})}addEventListener(e,s){super.addEventListener(e,s)}removeEventListener(e,s){super.removeEventListener(e,s)}notifyProgress(){const e=this;this.dispatchEvent(new CustomEvent("progress",{detail:{get progress(){return e.progress},get caption(){return e.caption}}}))}notifyDone(){this.dispatchEvent(new CustomEvent("done"))}}exports.EmscriptenDownloadMonitor=M;exports.ProgressObserver=k;exports.ProgressTracker=w;exports.cloneResponseMonitorProgress=C;
