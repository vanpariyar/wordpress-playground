"use strict";(self.webpackChunkdocusaurus_classic_typescript=self.webpackChunkdocusaurus_classic_typescript||[]).push([[7880],{5831:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>s});var i=n(11),r=(n(2735),n(9530));const a={},l="Compiling PHP",o={unversionedId:"architecture/wasm-php-compiling",id:"architecture/wasm-php-compiling",title:"Compiling PHP",description:"The build pipeline lives in a Dockerfile. It was originally forked from seanmorris/php-wasm",source:"@site/docs/11-architecture/03-wasm-php-compiling.md",sourceDirName:"11-architecture",slug:"/architecture/wasm-php-compiling",permalink:"/wordpress-playground/docs/architecture/wasm-php-compiling",draft:!1,editUrl:"https://github.com/WordPress/wordpress-playground/tree/trunk/packages/docs/site/docs/11-architecture/03-wasm-php-compiling.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"WebAssembly PHP",permalink:"/wordpress-playground/docs/architecture/wasm-php-overview"},next:{title:"PHP.js JavaScript module",permalink:"/wordpress-playground/docs/architecture/wasm-php-javascript-module"}},p={},s=[{value:"Building",id:"building",level:3},{value:"PHP extensions",id:"php-extensions",level:3},{value:"C API exposed to JavaScript",id:"c-api-exposed-to-javascript",level:3},{value:"Build configuration",id:"build-configuration",level:3}],d={toc:s},m="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(m,(0,i.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"compiling-php"},"Compiling PHP"),(0,r.kt)("p",null,"The build pipeline lives in a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/Dockerfile"},(0,r.kt)("inlineCode",{parentName:"a"},"Dockerfile")),". It was originally forked from ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/seanmorris/php-wasm"},"seanmorris/php-wasm")),(0,r.kt)("p",null,"In broad strokes, that ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Installs all the necessary linux packages (like ",(0,r.kt)("inlineCode",{parentName:"li"},"build-essential"),")"),(0,r.kt)("li",{parentName:"ul"},"Downloads PHP and the required libraries, e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"sqlite3"),"."),(0,r.kt)("li",{parentName:"ul"},"Applies a few patches."),(0,r.kt)("li",{parentName:"ul"},"Compiles everything using ",(0,r.kt)("a",{parentName:"li",href:"https://emscripten.org/"},"Emscripten"),", a drop-in replacement for the C compiler."),(0,r.kt)("li",{parentName:"ul"},"Compiles ",(0,r.kt)("inlineCode",{parentName:"li"},"php_wasm.c")," \u2013 a convenient API for JavaScript."),(0,r.kt)("li",{parentName:"ul"},"Outputs a ",(0,r.kt)("inlineCode",{parentName:"li"},"php.wasm")," file and one or more JavaScript loaders, depending on the configuration."),(0,r.kt)("li",{parentName:"ul"},"Transforms the Emscripten's default ",(0,r.kt)("inlineCode",{parentName:"li"},"php.js")," output into an ESM module with additional features.")),(0,r.kt)("p",null,"To find out more about each step, refer directly to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/Dockerfile"},"Dockerfile"),"."),(0,r.kt)("h3",{id:"building"},"Building"),(0,r.kt)("p",null,"To build all PHP versions, run ",(0,r.kt)("inlineCode",{parentName:"p"},"nx recompile-php:all php-wasm-web")," (or ",(0,r.kt)("inlineCode",{parentName:"p"},"php-wasm-node"),") in the repository root. You'll find the output files in ",(0,r.kt)("inlineCode",{parentName:"p"},"packages/php-wasm/php-web/public"),". To build a specific version, run ",(0,r.kt)("inlineCode",{parentName:"p"},"nx recompile-php:all php-wasm-node --PHP_VERSION=8.0"),"."),(0,r.kt)("h3",{id:"php-extensions"},"PHP extensions"),(0,r.kt)("p",null,"PHP is built with several extensions listed in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/Dockerfile"},(0,r.kt)("inlineCode",{parentName:"a"},"Dockerfile")),"."),(0,r.kt)("p",null,"Some extensions, like ",(0,r.kt)("inlineCode",{parentName:"p"},"zip"),", can be turned on or off during the build. Others, like ",(0,r.kt)("inlineCode",{parentName:"p"},"sqlite3"),", are hardcoded."),(0,r.kt)("p",null,"If you need to turn off one of the hardcoded extensions, feel free to open an issue in this repo. Better yet, this project needs contributors. You are more than welcome to open a PR and author the change you need."),(0,r.kt)("h3",{id:"c-api-exposed-to-javascript"},"C API exposed to JavaScript"),(0,r.kt)("p",null,"The C API exposed to JavaScript lives in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/build-assets/php_wasm.c"},(0,r.kt)("inlineCode",{parentName:"a"},"php_wasm.c"))," file. The most important functions are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"void phpwasm_init()")," \u2013 It creates a new PHP context and must be called before running any PHP code."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"int phpwasm_run(char *code)")," \u2013 Runs a PHP script and writes the output to /tmp/stdout and /tmp/stderr. Returns the exit code."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"void phpwasm_refresh()")," \u2013 Destroy the current PHP context and starts a new one. Call it after running one PHP script and before running another.")),(0,r.kt)("p",null,"Refer to the inline documentation in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/blob/trunk/src/packages/php-wasm/compile/build-assets/php_wasm.c"},(0,r.kt)("inlineCode",{parentName:"a"},"php_wasm.c"))," to learn more."),(0,r.kt)("h3",{id:"build-configuration"},"Build configuration"),(0,r.kt)("p",null,"The build is configurable via the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/reference/commandline/build/#set-build-time-variables---build-arg"},"Docker ",(0,r.kt)("inlineCode",{parentName:"a"},"--build-arg")," feature"),". You can set them up through the ",(0,r.kt)("inlineCode",{parentName:"p"},"build.js")," script, just run this command to get the usage message:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"nx recompile-php php-wasm-web\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Supported build options:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"PHP_VERSION")," \u2013 The PHP version to build, default: ",(0,r.kt)("inlineCode",{parentName:"li"},"8.0.24"),". This value must point to an existing branch of the ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/php/php-src.git"},"https://github.com/php/php-src.git")," repository when prefixed with ",(0,r.kt)("inlineCode",{parentName:"li"},"PHP-"),". For example, ",(0,r.kt)("inlineCode",{parentName:"li"},"7.4.0")," is valid because the branch ",(0,r.kt)("inlineCode",{parentName:"li"},"PHP-7.4.0")," exists, but just ",(0,r.kt)("inlineCode",{parentName:"li"},"7")," is invalid because there's no branch ",(0,r.kt)("inlineCode",{parentName:"li"},"PHP-7"),". The PHP versions that are known to work are ",(0,r.kt)("inlineCode",{parentName:"li"},"7.4.*")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"8.0.*"),". Others likely work as well but they haven't been tried."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"EMSCRIPTEN_ENVIRONMENT")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"web")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"node"),", default: ",(0,r.kt)("inlineCode",{parentName:"li"},"web"),". The platform to build for. When building for ",(0,r.kt)("inlineCode",{parentName:"li"},"web"),", two JavaScript loaders will be created: ",(0,r.kt)("inlineCode",{parentName:"li"},"php-web.js")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"php-webworker.js"),". When building for Node.js, only one loader called ",(0,r.kt)("inlineCode",{parentName:"li"},"php-node.js")," will be created."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"WITH_LIBXML")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"yes")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"no"),", default: ",(0,r.kt)("inlineCode",{parentName:"li"},"no"),". Whether to build with ",(0,r.kt)("inlineCode",{parentName:"li"},"libxml2")," and the ",(0,r.kt)("inlineCode",{parentName:"li"},"dom"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"xml"),", and ",(0,r.kt)("inlineCode",{parentName:"li"},"simplexml")," PHP extensions (",(0,r.kt)("inlineCode",{parentName:"li"},"DOMDocument"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"SimpleXML"),", ..)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"WITH_LIBZIP")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"yes")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"no"),", default: ",(0,r.kt)("inlineCode",{parentName:"li"},"yes"),". Whether to build with ",(0,r.kt)("inlineCode",{parentName:"li"},"zlib"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"libzip"),", and the ",(0,r.kt)("inlineCode",{parentName:"li"},"zip")," PHP extension (",(0,r.kt)("inlineCode",{parentName:"li"},"ZipArchive"),")."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"WITH_VRZNO")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"yes")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"no"),", default: ",(0,r.kt)("inlineCode",{parentName:"li"},"yes")," when PHP_VERSION is 7.","*",". Whether to build with ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/seanmorris/vrzno/fork"},"the ",(0,r.kt)("inlineCode",{parentName:"a"},"vrzno")," PHP extension")," that enables running JavaScript code from PHP."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"WITH_NODEFS")," \u2013 ",(0,r.kt)("inlineCode",{parentName:"li"},"yes")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"no"),", default: ",(0,r.kt)("inlineCode",{parentName:"li"},"no"),". Whether to include ",(0,r.kt)("a",{parentName:"li",href:"https://emscripten.org/docs/api_reference/Filesystem-API.html#filesystem-api-nodefs"},"the Emscripten's NODEFS JavaScript library"),". It's useful for loading files and mounting directories from the local filesystem when running php.wasm from Node.js.")))}u.isMDXComponent=!0},9530:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var i=n(2735);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=i.createContext({}),s=function(e){var t=i.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=s(e.components);return i.createElement(p.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},c=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,p=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),m=s(n),c=r,h=m["".concat(p,".").concat(c)]||m[c]||u[c]||a;return n?i.createElement(h,l(l({ref:t},d),{},{components:n})):i.createElement(h,l({ref:t},d))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=c;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o[m]="string"==typeof e?e:r,l[1]=o;for(var s=2;s<a;s++)l[s]=n[s];return i.createElement.apply(null,l)}return i.createElement.apply(null,n)}c.displayName="MDXCreateElement"}}]);