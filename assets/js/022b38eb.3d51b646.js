"use strict";(self.webpackChunkdocusaurus_classic_typescript=self.webpackChunkdocusaurus_classic_typescript||[]).push([[5992],{4275:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var a=n(11),r=(n(2735),n(9530));const s={},i="Asyncify",o={unversionedId:"architecture/wasm-asyncify",id:"architecture/wasm-asyncify",title:"Asyncify",description:"Asyncify lets synchronous C or C++ code interact with asynchronous JavaScript. Technically, it saves the entire C call stack before yielding control back to JavaScript, and then restores it when the asynchronous call is finished. This is called stack switching.",source:"@site/docs/11-architecture/07-wasm-asyncify.md",sourceDirName:"11-architecture",slug:"/architecture/wasm-asyncify",permalink:"/wordpress-playground/docs/architecture/wasm-asyncify",draft:!1,editUrl:"https://github.com/WordPress/wordpress-playground/tree/trunk/packages/docs/site/docs/11-architecture/07-wasm-asyncify.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Data dependencies (browser version)",permalink:"/wordpress-playground/docs/architecture/wasm-php-data-dependencies"},next:{title:"Running PHP apps in the browser with ServiceWorkers and Worker Threads",permalink:"/wordpress-playground/docs/architecture/browser-concepts"}},c={},l=[{value:"Asyncify crashes",id:"asyncify-crashes",level:2},{value:"Fixing Asyncify crashes",id:"fixing-asyncify-crashes",level:2},{value:"The upcoming JSPI API will make Asyncify unnecessary",id:"the-upcoming-jspi-api-will-make-asyncify-unnecessary",level:2}],p={toc:l},u="wrapper";function h(e){let{components:t,...s}=e;return(0,r.kt)(u,(0,a.Z)({},p,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"asyncify"},"Asyncify"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://emscripten.org/docs/porting/asyncify.html"},"Asyncify")," lets synchronous C or C++ code interact with asynchronous JavaScript. Technically, it saves the entire C call stack before yielding control back to JavaScript, and then restores it when the asynchronous call is finished. This is called ",(0,r.kt)("strong",{parentName:"p"},"stack switching"),"."),(0,r.kt)("p",null,"Networking support in the WebAssembly PHP build is implemented using Asyncify. When PHP makes a network request, it yields control back to JavaScript, which makes the request, and then resumes PHP when the response is ready. It works well enough that PHP build can request web APIs, install composer packages, and even connect to a MySQL server."),(0,r.kt)("h2",{id:"asyncify-crashes"},"Asyncify crashes"),(0,r.kt)("p",null,"Stack switching requires wrapping all C functions that may be found at a call stack at a time of making an asynchronous call. Blanket-wrapping of every single C function adds a ",(0,r.kt)("strong",{parentName:"p"},"significant")," overhead, which is why we maintain a list of specific function names:"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/blob/15a660940ee9b4a332965ba2a987f6fda0c159b1/packages/php-wasm/compile/Dockerfile#L624-L632"},"https://github.com/WordPress/wordpress-playground/blob/15a660940ee9b4a332965ba2a987f6fda0c159b1/packages/php-wasm/compile/Dockerfile#L624-L632")),(0,r.kt)("p",null,"Unfortunately, missing even a single item from that list results in a WebAssembly crash whenever that function is a part of the call stack when an asynchronous call is made. It looks like this:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"A screenshot of an asyncify error in the terminal",src:n(3803).Z,width:"2116",height:"1404"})),(0,r.kt)("p",null,"Asyncify can auto-list all the required C functions when built without ",(0,r.kt)("inlineCode",{parentName:"p"},"ASYNCIFY_ONLY"),", but that auto-detection is overeager and ends up listing about 70,000 C functions which increases the startup time to 4.5s. That's why we maintain the list manually."),(0,r.kt)("p",null,"If you are interested in more details, ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/issues/251"},"see GitHub issue 251"),"."),(0,r.kt)("h2",{id:"fixing-asyncify-crashes"},"Fixing Asyncify crashes"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/pull/253"},"Pull Request 253")," adds a ",(0,r.kt)("inlineCode",{parentName:"p"},"fix-asyncify")," command that runs a specialized test suite and automatically adds any identified missing C functions to the ",(0,r.kt)("inlineCode",{parentName:"p"},"ASYNCIFY_ONLY")," list."),(0,r.kt)("p",null,"If you run into a crash like the one above, you can fix it by:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Identifying a PHP code path that triggers the crash \u2013 the stack trace in the terminal should help with that."),(0,r.kt)("li",{parentName:"ol"},"Adding a test case that triggers a crash to ",(0,r.kt)("inlineCode",{parentName:"li"},"packages/php-wasm/node/src/test/php-asyncify.spec.ts")),(0,r.kt)("li",{parentName:"ol"},"Running: ",(0,r.kt)("inlineCode",{parentName:"li"},"npm run fix-asyncify")),(0,r.kt)("li",{parentName:"ol"},"Committing the test case, the updated Dockerfile, and the rebuilt PHP.wasm")),(0,r.kt)("h2",{id:"the-upcoming-jspi-api-will-make-asyncify-unnecessary"},"The upcoming JSPI API will make Asyncify unnecessary"),(0,r.kt)("p",null,"Eventually, ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/issues/134"},"V8 will likely handle stack switching for us")," and remove this problem entirely. ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/issues/134"},"Issue 134")," tracks the status of that effort."),(0,r.kt)("p",null,"Here's ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fgmccabe"},"a relevant note")," from @fgmccabe:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"The current implementation in V8 is essentially 'experimental status'. We have arm64 and x64 implementations.\nThe next steps are to implement on 32 bit arm/intel. That requires us to solve some issues that we did not have to solve so far.\nAs for node.js, my guess is that it is already in node, behind a flag.\nTo remove the flag requirement involves getting other implementations. The best estimate for that is towards the end of this year; but it obviously depends on resources and funding.\nIn addition, it would need further progress in the standardization effort; but, given that it is a 'small' spec, that should not be a long term burden.\nHope that this helps you understand the roadmap :)")))}h.isMDXComponent=!0},9530:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>y});var a=n(2735);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,c=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=l(n),d=r,y=u["".concat(c,".").concat(d)]||u[d]||h[d]||s;return n?a.createElement(y,i(i({ref:t},p),{},{components:n})):a.createElement(y,i({ref:t},p))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,i=new Array(s);i[0]=d;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o[u]="string"==typeof e?e:r,i[1]=o;for(var l=2;l<s;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3803:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/asyncify-error-d98fdbfe4ea2ff5c9393f3b0b7cc9032.png"}}]);