"use strict";(self.webpackChunkdocusaurus_classic_typescript=self.webpackChunkdocusaurus_classic_typescript||[]).push([[6939],{1010:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>i,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>p,toc:()=>c});var n=r(11),o=(r(2735),r(9530));const a={},s="Scopes",p={unversionedId:"architecture/browser-scopes",id:"architecture/browser-scopes",title:"Scopes",description:"Scopes keep your app working when you open it in two different different browser tabs.",source:"@site/docs/11-architecture/13-browser-scopes.md",sourceDirName:"11-architecture",slug:"/architecture/browser-scopes",permalink:"/wordpress-playground/docs/architecture/browser-scopes",draft:!1,editUrl:"https://github.com/WordPress/wordpress-playground/tree/trunk/packages/docs/site/docs/11-architecture/13-browser-scopes.md",tags:[],version:"current",sidebarPosition:13,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Service Workers",permalink:"/wordpress-playground/docs/architecture/browser-service-workers"},next:{title:"Cross-process communication",permalink:"/wordpress-playground/docs/architecture/browser-cross-process-communication"}},i={},c=[],l={toc:c},u="wrapper";function d(e){let{components:t,...r}=e;return(0,o.kt)(u,(0,n.Z)({},l,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"scopes"},"Scopes"),(0,o.kt)("p",null,"Scopes keep your app working when you open it in two different different browser tabs."),(0,o.kt)("p",null,"The Service Worker passes the intercepted HTTP requests to the PHPRequestHandler for rendering. Technically, it sends a message through a ",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/API/BroadcastChannel"},(0,o.kt)("inlineCode",{parentName:"a"},"BroadcastChannel"))," which then gets delivered to every browser tab where the application is open. This is undesirable, slow, and leads to unexpected behaviors."),(0,o.kt)("p",null,"Unfortunately, the Service Worker cannot directly communicate with the relevant Worker Thread \u2013 see ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/pull/31"},"PR #31")," and ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/issues/9"},"issue #9")," for more details."),(0,o.kt)("p",null,"Scopes enable each browser tab to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Brand the outgoing HTTP requests with a unique tab id"),(0,o.kt)("li",{parentName:"ul"},"Ignore any ",(0,o.kt)("inlineCode",{parentName:"li"},"BroadcastChannel")," messages with a different id")),(0,o.kt)("p",null,"Technically, a scope is a string included in the ",(0,o.kt)("inlineCode",{parentName:"p"},"PHPRequestHandler.absoluteUrl"),". For example:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"In an ",(0,o.kt)("strong",{parentName:"li"},"unscoped app"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"/index.php")," would be available at ",(0,o.kt)("inlineCode",{parentName:"li"},"http://localhost:8778/wp-login.php")),(0,o.kt)("li",{parentName:"ul"},"In an ",(0,o.kt)("strong",{parentName:"li"},"scoped app"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"/index.php")," would be available at ",(0,o.kt)("inlineCode",{parentName:"li"},"http://localhost:8778/scope:96253/wp-login.php"))),(0,o.kt)("p",null,"The service worker is aware of this concept and will attach the ",(0,o.kt)("inlineCode",{parentName:"p"},"/scope:")," found in the request URL to the related ",(0,o.kt)("inlineCode",{parentName:"p"},"BroadcastChannel")," communication."),(0,o.kt)("p",null,"A worker thread initiated with a scoped ",(0,o.kt)("inlineCode",{parentName:"p"},"absoluteUrl")," is said to be ",(0,o.kt)("strong",{parentName:"p"},"scoped"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import {\n    PHP,\n    setURLScope,\n    exposeAPI,\n    parseWorkerStartupOptions,\n} from '@php-wasm/web';\n\n// Don't use the absoluteURL directly:\nconst absoluteURL = 'http://127.0.0.1'\n\n// Instead, set the scope first:\nconst scope = Math.random().toFixed(16)\nconst scopedURL = setURLScope(absoluteURL, scope).toString()\n\nconst { phpVersion } = parseWorkerStartupOptions<{ phpVersion?: string }>();\nconst php = await PHP.load('8.0', {\n    requestHandler: {\n        documentRoot: '/',\n        absoluteUrl: scopedSiteUrl\n    }\n});\n\n// Expose the API to app.ts:\nconst [setApiReady, ] = exposeAPI( php );\nsetApiReady();\n")))}d.isMDXComponent=!0},9530:(e,t,r)=>{r.d(t,{Zo:()=>l,kt:()=>m});var n=r(2735);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function p(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var i=n.createContext({}),c=function(e){var t=n.useContext(i),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},l=function(e){var t=c(e.components);return n.createElement(i.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var r=e.components,o=e.mdxType,a=e.originalType,i=e.parentName,l=p(e,["components","mdxType","originalType","parentName"]),u=c(r),h=o,m=u["".concat(i,".").concat(h)]||u[h]||d[h]||a;return r?n.createElement(m,s(s({ref:t},l),{},{components:r})):n.createElement(m,s({ref:t},l))}));function m(e,t){var r=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=r.length,s=new Array(a);s[0]=h;var p={};for(var i in t)hasOwnProperty.call(t,i)&&(p[i]=t[i]);p.originalType=e,p[u]="string"==typeof e?e:o,s[1]=p;for(var c=2;c<a;c++)s[c]=r[c];return n.createElement.apply(null,s)}return n.createElement.apply(null,r)}h.displayName="MDXCreateElement"}}]);