"use strict";(self.webpackChunkdocusaurus_classic_typescript=self.webpackChunkdocusaurus_classic_typescript||[]).push([[6185],{994:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var n=t(11),a=(t(2735),t(9530));const o={},i="PHP Worker Threads",s={unversionedId:"architecture/browser-php-worker-threads",id:"architecture/browser-php-worker-threads",title:"PHP Worker Threads",description:"PHP is always ran in a separate thread we'll call a \"Worker Thread.\" This happens to ensure the PHP runtime doesn't slow down the website.",source:"@site/docs/11-architecture/11-browser-php-worker-threads.md",sourceDirName:"11-architecture",slug:"/architecture/browser-php-worker-threads",permalink:"/wordpress-playground/docs/architecture/browser-php-worker-threads",draft:!1,editUrl:"https://github.com/WordPress/wordpress-playground/tree/trunk/packages/docs/site/docs/11-architecture/11-browser-php-worker-threads.md",tags:[],version:"current",sidebarPosition:11,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Iframe-based rendering",permalink:"/wordpress-playground/docs/architecture/browser-iframe-rendering"},next:{title:"Service Workers",permalink:"/wordpress-playground/docs/architecture/browser-service-workers"}},l={},p=[{value:"Initiating the worker thread",id:"initiating-the-worker-thread",level:3},{value:"Controlling the worker thread",id:"controlling-the-worker-thread",level:3},{value:"Worker thread backends",id:"worker-thread-backends",level:3},{value:"<code>webworker</code>",id:"webworker",level:4},{value:"<code>iframe</code>",id:"iframe",level:4}],c={toc:p},d="wrapper";function h(e){let{components:r,...t}=e;return(0,a.kt)(d,(0,n.Z)({},c,t,{components:r,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"php-worker-threads"},"PHP Worker Threads"),(0,a.kt)("p",null,"PHP is always ran in a separate thread we'll call a \"Worker Thread.\" This happens to ensure the PHP runtime doesn't slow down the website."),(0,a.kt)("p",null,"Imagine the following code:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'<button onclick="for(let i=0;i<100000000;i++>) {}">Freeze the page</button>\n<input type="text" />\n')),(0,a.kt)("p",null,"As soon as you click that button the browser will freeze and you won't be able to type in the input. That's just how browsers work. Whether it's a for loop or a PHP server, running intensive tasks slows down the user interface."),(0,a.kt)("h3",{id:"initiating-the-worker-thread"},"Initiating the worker thread"),(0,a.kt)("p",null,"Worker threads are separate programs that can process heavy tasks outside of the main application. They must be initiated by the main JavaScript program living in the browser tab. Here's how:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},'const phpClient = consumeAPI<PHPClient>(\n    spawnPHPWorkerThread(\n        \'/worker-thread.js\', // Valid Worker script URL\n        recommendedWorkerBackend // "webworker" or "iframe", see the docstring\n    )\n);\nawait phpClient.isReady();\nawait phpClient.run({ code: `<?php echo "Hello from the thread!";` });\n')),(0,a.kt)("p",null,"Worker threads can use any multiprocessing technique like an iframe, WebWorker, or a SharedWorker (not implemented). See the next sections to learn more about the supported backends."),(0,a.kt)("h3",{id:"controlling-the-worker-thread"},"Controlling the worker thread"),(0,a.kt)("p",null,"The main application controls the worker thread by sending and receiving messages. This is implemented via a backend-specific flavor of ",(0,a.kt)("inlineCode",{parentName:"p"},"postMessage")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"addEventListener('message', fn)"),"."),(0,a.kt)("p",null,"Exchanging messages is the only way to control the worker threads. Remember \u2013 it is separate programs. The main app cannot access any functions or variables defined inside of the worker thread."),(0,a.kt)("p",null,"Conveniently, ",(0,a.kt)("a",{parentName:"p",href:"/api/web/function/consumeAPI"},"consumeAPI")," returns an easy-to-use API object that exposes specific worker thread features and handles the message exchange internally."),(0,a.kt)("h3",{id:"worker-thread-backends"},"Worker thread backends"),(0,a.kt)("p",null,"Worker threads can use any multiprocessing technique like an iframe, WebWorker, or a SharedWorker. This package provides two backends out of the box:"),(0,a.kt)("h4",{id:"webworker"},(0,a.kt)("inlineCode",{parentName:"h4"},"webworker")),(0,a.kt)("p",null,"Spins a new ",(0,a.kt)("inlineCode",{parentName:"p"},"Worker")," instance with the given Worker Thread script. This is the classic solution for multiprocessing in the browser and it almost became the only, non-configurable backend. The ",(0,a.kt)("inlineCode",{parentName:"p"},"iframe")," backend is handy to work around webworkers limitations in the browsers. For example, ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/mdn/content/issues/24402"},"Firefox does not support module workers")," and ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/WordPress/wordpress-playground/issues/1"},"WASM used to crash webworkers in Chrome"),"."),(0,a.kt)("p",null,"Example usage:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const phpClient = consumeAPI<PHPClient>(spawnPHPWorkerThread('/worker-thread.js', 'webworker'));\n")),(0,a.kt)("h4",{id:"iframe"},(0,a.kt)("inlineCode",{parentName:"h4"},"iframe")),(0,a.kt)("p",null,"Loads the PHPRequestHandler in a new iframe to avoid crashes in browsers based on Google Chrome."),(0,a.kt)("p",null,"The browser will ",(0,a.kt)("strong",{parentName:"p"},"typically")," run an iframe in a separate thread in one of the two cases:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"iframe-worker.html")," is served with the ",(0,a.kt)("inlineCode",{parentName:"li"},"Origin-Agent-Cluster: ?1")," header. If you're running the Apache webserver, this package ships a ",(0,a.kt)("inlineCode",{parentName:"li"},".htaccess")," that will add the header for you."),(0,a.kt)("li",{parentName:"ol"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"iframe-worker.html")," is served from a different origin. For convenience, you could point a second domain name to the same server and directory and use it just for the ",(0,a.kt)("inlineCode",{parentName:"li"},"iframe-worker.html"),".")),(0,a.kt)("p",null,"Pick your favorite option and make sure to use it for serving the ",(0,a.kt)("inlineCode",{parentName:"p"},"iframe-worker.html"),"."),(0,a.kt)("p",null,"Example usage:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"/app.js"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const phpClient = consumeAPI<PHPClient>(spawnPHPWorkerThread('/iframe-worker.html?script=/worker-thread.js', 'iframe'));\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"/iframe-worker.html")," (Also provided in ",(0,a.kt)("inlineCode",{parentName:"p"},"@php-wasm/web")," package):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"<!DOCTYPE html>\n<html>\n  <head></head>\n  <body style=\"padding: 0; margin: 0\">\n    <script>\n      const script = document.createElement('script');\n      script.type = 'module';\n      script.src = getEscapeScriptName();\n      document.body.appendChild(script);\n\n      function getEscapeScriptName() {\n        // Grab ?script= query parameter and securely escape it\n      }\n    <\/script>\n  </body>\n</html>\n")))}h.isMDXComponent=!0},9530:(e,r,t)=>{t.d(r,{Zo:()=>c,kt:()=>m});var n=t(2735);function a(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function o(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function i(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?o(Object(t),!0).forEach((function(r){a(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function s(e,r){if(null==e)return{};var t,n,a=function(e,r){if(null==e)return{};var t,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)t=o[n],r.indexOf(t)>=0||(a[t]=e[t]);return a}(e,r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)t=o[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=n.createContext({}),p=function(e){var r=n.useContext(l),t=r;return e&&(t="function"==typeof e?e(r):i(i({},r),e)),t},c=function(e){var r=p(e.components);return n.createElement(l.Provider,{value:r},e.children)},d="mdxType",h={inlineCode:"code",wrapper:function(e){var r=e.children;return n.createElement(n.Fragment,{},r)}},u=n.forwardRef((function(e,r){var t=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(t),u=a,m=d["".concat(l,".").concat(u)]||d[u]||h[u]||o;return t?n.createElement(m,i(i({ref:r},c),{},{components:t})):n.createElement(m,i({ref:r},c))}));function m(e,r){var t=arguments,a=r&&r.mdxType;if("string"==typeof e||a){var o=t.length,i=new Array(o);i[0]=u;var s={};for(var l in r)hasOwnProperty.call(r,l)&&(s[l]=r[l]);s.originalType=e,s[d]="string"==typeof e?e:a,i[1]=s;for(var p=2;p<o;p++)i[p]=t[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,t)}u.displayName="MDXCreateElement"}}]);